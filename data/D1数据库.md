-- sql - 数据库表结构
```bash

-- ========================
-- 完整的D1数据库表结构
-- ========================

-- 1. 消息映射表（存储转发消息与用户ID的对应关系）
CREATE TABLE IF NOT EXISTS msg_map (
    message_id INTEGER PRIMARY KEY,
    chat_id TEXT NOT NULL,
    created_at INTEGER DEFAULT (unixepoch())
);

-- 2. 屏蔽用户表
CREATE TABLE IF NOT EXISTS blocked_users (
    chat_id TEXT PRIMARY KEY,
    is_blocked INTEGER DEFAULT 0,
    updated_at INTEGER DEFAULT (unixepoch())
);

-- 3. 欺诈用户数据库
CREATE TABLE IF NOT EXISTS fraud_users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT UNIQUE NOT NULL,
    created_at INTEGER DEFAULT (unixepoch())
);

-- 4. 登录尝试记录表（新增）
CREATE TABLE IF NOT EXISTS login_attempts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    ip_address TEXT NOT NULL,
    attempt_count INTEGER DEFAULT 0,
    last_attempt INTEGER DEFAULT (unixepoch()),
    blocked_until INTEGER DEFAULT 0,
    created_at INTEGER DEFAULT (unixepoch())
);

-- ========================
-- 索引优化
-- ========================

-- msg_map 表的索引
CREATE INDEX IF NOT EXISTS idx_msg_map_chat_id ON msg_map(chat_id);
CREATE INDEX IF NOT EXISTS idx_msg_map_created_at ON msg_map(created_at);

-- blocked_users 表的索引
CREATE INDEX IF NOT EXISTS idx_blocked_users_is_blocked ON blocked_users(is_blocked);
CREATE INDEX IF NOT EXISTS idx_blocked_users_updated_at ON blocked_users(updated_at);

-- fraud_users 表的索引
CREATE INDEX IF NOT EXISTS idx_fraud_users_created_at ON fraud_users(created_at);

-- login_attempts 表的索引
CREATE INDEX IF NOT EXISTS idx_login_attempts_ip ON login_attempts(ip_address);
CREATE INDEX IF NOT EXISTS idx_login_attempts_blocked ON login_attempts(blocked_until);
CREATE INDEX IF NOT EXISTS idx_login_attempts_last_attempt ON login_attempts(last_attempt);

-- ========================
-- 示例数据（可选）
-- ========================

-- 插入一些示例数据用于测试
-- INSERT OR IGNORE INTO blocked_users (chat_id, is_blocked, updated_at) 
-- VALUES ('123456789', 1, unixepoch());

-- INSERT OR IGNORE INTO fraud_users (user_id, created_at) 
-- VALUES ('123456789', unixepoch());

-- ========================
-- 视图（可选，用于复杂查询）
-- ========================

-- 创建一个视图，显示欺诈用户的详细信息
CREATE VIEW IF NOT EXISTS v_fraud_users_detail AS
SELECT 
    f.user_id,
    f.created_at,
    datetime(f.created_at, 'unixepoch') as created_date,
    b.is_blocked,
    b.updated_at,
    datetime(b.updated_at, 'unixepoch') as blocked_date,
    CASE 
        WHEN b.is_blocked = 1 THEN '已屏蔽'
        ELSE '活跃'
    END as status_text
FROM fraud_users f
LEFT JOIN blocked_users b ON f.user_id = b.chat_id;

-- 创建一个视图，显示登录尝试统计
CREATE VIEW IF NOT EXISTS v_login_stats AS
SELECT 
    ip_address,
    attempt_count,
    datetime(last_attempt, 'unixepoch') as last_attempt_date,
    CASE 
        WHEN blocked_until > 0 THEN datetime(blocked_until, 'unixepoch')
        ELSE '未阻止'
    END as blocked_until_date,
    CASE 
        WHEN blocked_until > 0 AND blocked_until > unixepoch() THEN '已阻止'
        ELSE '正常'
    END as current_status
FROM login_attempts;

-- ========================
-- 触发器（可选）
-- ========================

-- 当添加用户到欺诈数据库时，自动屏蔽该用户
CREATE TRIGGER IF NOT EXISTS trg_auto_block_after_fraud_insert
AFTER INSERT ON fraud_users
BEGIN
    INSERT OR REPLACE INTO blocked_users (chat_id, is_blocked, updated_at)
    VALUES (NEW.user_id, 1, unixepoch());
END;

-- 当删除欺诈用户时，也删除对应的屏蔽记录
CREATE TRIGGER IF NOT EXISTS trg_auto_unblock_after_fraud_delete
AFTER DELETE ON fraud_users
BEGIN
    DELETE FROM blocked_users WHERE chat_id = OLD.user_id;
END;

-- 当更新屏蔽状态时，更新更新时间
CREATE TRIGGER IF NOT EXISTS trg_update_timestamp_on_block
AFTER UPDATE ON blocked_users
BEGIN
    UPDATE blocked_users SET updated_at = unixepoch() WHERE chat_id = NEW.chat_id;
END;

-- ========================
-- 清理和维护语句
-- ========================

-- 清理30天前的消息记录（可以在定时任务中执行）
-- DELETE FROM msg_map WHERE created_at < unixepoch() - (30 * 24 * 60 * 60);

-- 清理已解除屏蔽超过7天的记录
-- DELETE FROM blocked_users WHERE is_blocked = 0 AND updated_at < unixepoch() - (7 * 24 * 60 * 60);

-- 清理30天前的登录尝试记录
-- DELETE FROM login_attempts WHERE created_at < unixepoch() - (30 * 24 * 60 * 60);

-- 数据库优化（可以在清理后执行）
-- VACUUM;
```
